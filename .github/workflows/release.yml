name: Release & Publish

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Release & Publish to Marketplace
    runs-on: ubuntu-latest
    permissions:
      contents: write   

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Compile
        run: npm run compile

      - name: Test
        run: xvfb-run -a npm test
        env:
          DISPLAY: ':99.0'

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package extension (.vsix)
        run: vsce package

      # CHANGELOG.md から最新バージョンのセクションだけを抽出してリリースノートにする
      - name: Extract release notes from CHANGELOG.md
        id: changelog
        run: |
          # v0.1.0 のような最新バージョンのセクションを抽出
          VERSION="${GITHUB_REF_NAME#v}"
          NOTES=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: "*.vsix"
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          # v0.1.0-beta.1 のように - を含むタグは prerelease 扱い
          token: ${{ secrets.GITHUB_TOKEN }} 

      - name: Publish to VS Marketplace
        uses: HaaLeo/publish-vscode-extension@v2
        with:
          pat: ${{ secrets.VSCE_PAT }}
          registryUrl: https://marketplace.visualstudio.com
